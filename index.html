<!DOCTYPE html>
<html lang="ja">
   <head>
      <title>緊急地震速報</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
      <meta http-equiv="Pragma" content="no-cache">
      <meta http-equiv="Expires" content="0">
    <style>
        body {
            font-family: sans-serif;
            font-size: 18px;
        }
        .warn {
            background-color: red;
        }
        #EEW, #EARTHQUAKEINFO, #Settings {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin-top: 0;
            font-size: 24px;
        }
        .large {
            font-size: 18px;
        }
        .warning-box {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
        }
        #earthquake-info, #earthquake-list {
            margin-bottom: 20px;
        }
        #save-button {
            display: block;
            margin-top: 10px;
        }
        
        button {
    background-color: #4CAF50;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

button:hover {
    background-color: #3e8e41;
}
input[type=text] {
    width: 35%;
    padding: 12px 20px;
    margin: 8px 0;
    box-sizing: border-box;
    border: 2px solid #ccc;
    border-radius: 4px;
}

input[type=text]:focus {
    border: 2px solid #4CAF50;
}


    </style>
</head>
<body>
    <div id="EEW">
        <h1>緊急地震速報</h1>
        <div id="earthquake-info"></div>
    </div>
    <div id="EARTHQUAKEINFO">
        <h2>地震情報</h2>
        <div id="earthquake-list"></div>
    </div>
    <div id="Settings">
        <h2>現在地</h2>
        <label for="user-location">現在地:</label>
        <input type="text" id="user-location">
        <button id="save-button">保存</button><p id="location"></p>
    </div>
      <script>
const earthquakeWarnings = {};

async function getData(apiEndpoint) {
    try {
        const response = await fetch(apiEndpoint, {
            cache: 'no-store'
        });

        const data = await response.json();
        return data;
    } catch (error) {
        console.error(error);
    }
}

async function main() {
    const apiEndpoint1 = 'https://api.iedred7584.com/eew/json/';
    const apiEndpoint2 = 'https://api.wolfx.jp/jma_eew.json';

    const data1 = await getData(apiEndpoint1);
    const data2 = await getData(apiEndpoint2);

    const currentTime = new Date();

    let latestData;
    if (new Date(data1.AnnouncedTime.String) <= new Date(data2.AnnouncedTime)) {
        latestData = {...data2, isIedred: false};
    } else {
        latestData = {...data1, isIedred: true};
    }

    if (latestData.isIedred) {
        transformedData = {
            isIedred: true,
            EventID: latestData.EventID,
            Title: latestData.Title.String,
            reportnum: latestData.Serial,
            isfinal: latestData.Type.Code === 9,
            iswarn: latestData.Warn,
            iscancel: latestData.Title.Code === 39,
            istrainning: latestData.Status.Code === 10,
            isplumepicenter: latestData.Hypocenter.isAssumption,
            report_time: latestData.AnnouncedTime.String,
            origin_time: latestData.OriginTime.String,
            hypocenter: latestData.Hypocenter.Name,
            magnitude: latestData.Hypocenter.Magnitude.Float,
            depth: latestData.Hypocenter.Location.Depth.Int,
            maxintensity: latestData.MaxIntensity.String,
            latitude: latestData.Hypocenter.Location.Lat,
            longitude: latestData.Hypocenter.Location.Long,
            Accuracy_epicenter: latestData.Hypocenter.Accuracy.Epicenter.String,
            Accuracy_depth: latestData.Hypocenter.Accuracy.Depth.String,
            Accuracy_magnitude: latestData.Hypocenter.Accuracy.Magnitude.String,
            forecast: (latestData.Forecast || []).map(item => ({
                chiiki: item.Intensity.Name,
                shindomax: item.Intensity.From,
                shindolowest: item.Intensity.To,
                isWarn: item.Warn
            }))
        };
    } else {
        transformedData = {
            isIedred: false,
            EventID: latestData.EventID,
            Title: latestData.Title,
            report_time: latestData.AnnouncedTime,
            origin_time: latestData.OriginTime,
            hypocenter: latestData.Hypocenter,
            reportnum: latestData.Serial,
            latitude: latestData.Latitude,
            longitude: latestData.Longitude,
            magnitude: latestData.Magunitude,
            maxintensity: latestData.MaxIntensity,
            depth: latestData.Depth,
            Accuracy_epicenter: latestData.Accuracy.Epicenter,
            Accuracy_depth: latestData.Accuracy.Depth,
            Accuracy_magnitude: latestData.Accuracy.Magnitude,
            iscancel: latestData.isCancel,
            isplumepicenter: latestData.isAssumption,
            istrainning: latestData.isTraining,
            iswarn: latestData.isWarn,
            isfinal: latestData.isFinal,
            forecast: (latestData.WarnArea || []).map(item => ({
                chiiki: item.Chiiki,
                shindomax: item.Shindo1,
                shindolowest: item.Shindo2,
                isWarn: item.Type === '警報'
            }))
        };
    }

    if (transformedData) {
        const eventId = transformedData.EventID;
        const reportTime = new Date(transformedData.report_time);
        if (currentTime - reportTime <= 300000) {
            earthquakeWarnings[eventId] = transformedData;
        } else {
            delete earthquakeWarnings[eventId];
        }
    }

    for (const eventId in earthquakeWarnings) {
        const warning = earthquakeWarnings[eventId];
        const reportTime = new Date(warning.report_time);
        if (warning.iscancel && currentTime - reportTime > 15000) {
            delete earthquakeWarnings[eventId];
        } else if (currentTime - reportTime > 300000) {
            delete earthquakeWarnings[eventId];
        }
    }

const earthquakeInfo = document.getElementById('earthquake-info');
let info = '';
const warnings = Object.values(earthquakeWarnings).sort((a, b) => new Date(b.report_time) - new Date(a.report_time));
if (warnings.length === 0) {
    info += `<p>緊急地震速報は発表されていません。</p>`;
} else {
    for (let i = 0; i < warnings.length; i++) {
        const warning = warnings[i];
        info += `<div class="warning-box" id="EEW[${warning.EventID}]">`;
        info += `<p class="large">#${i + 1}</p>`;
            console.log(warning)
            if (warning.iscancel) {
                info += `<p>緊急地震速報は取り消されました。</p>`;
            } else {
            info += ` <p>${warning.iswarn ? '緊急地震速報(警報)' : '緊急地震速報(予報)'}</p> <p>震源地: ${warning.hypocenter}</p> <p>${warning.isfinal ? ((warning.reportnum) ? `最終第${(warning.reportnum)}報` : '最終報') : ((warning.reportnum) ? `第${(warning.reportnum)}報` : '未定義')}</p> <p>予想最大震度: ${warning.maxintensity}</p> `;

            const userLocation = getUserLocationFromCookie();
if (userLocation) {
    if (warning.maxintensity) {
        const maxIntensity = warning.maxintensity;
        if ((warning.isIedred && warning.iswarn) || (!warning.isIedred && maxIntensity >= 4)) {
            const userLocationData = warning.forecast.find(area => area.chiiki === userLocation);
            if (userLocationData) {
                info += `<p>現在地(${userLocation})の予想震度: ${userLocationData.shindomax}</p>`;
                warning.expectedIntensity = userLocationData.shindomax;
            } else {
                info += `<p>現在地(${userLocation})の予想震度: 不明</p>`;
                warning.expectedIntensity = '不明';
            }
        } else {
            info += `<p>現在地(${userLocation})の予想震度: 不明</p>`;
            warning.expectedIntensity = '不明';
        }
    } else {
        info += `<p>現在地(${userLocation})の予想震度: 不明</p>`;
        warning.expectedIntensity = '不明';
    }
}

            if (!warning.isplumepicenter) {
                info += ` <p>マグニチュード: ${warning.magnitude}</p> <p>深さ: ${(warning.depth ? (warning.depth + 'km') : warning.depth)}</p> `;
                if (warning.origin_time) {
                    info += ` <p>${warning.origin_time} 発生</p> `;
                }
                if (warning.Accuracy_epicenter) {
                    info += `<p>精度情報 震源: ${warning.Accuracy_epicenter}, 深さ: ${warning.Accuracy_depth}, マグニチュード: ${warning.Accuracy_magnitude.replace('（最大5 点）', '')}</p>`;
                }
            } else {
                info += ` <p>${warning.OriginTime}頃検知</p> <p>仮定震源要素のため、震源の深さおよびM不明</p> `;
            }
            if (warning.forecast && warning.forecast.length > 0) {
                info += `<p>地域ごとの予想震度(気象庁発表)</p><p>`;
                for (const area of warning.forecast) {
                    info += `${area.chiiki} ${area.shindomax}`;
                    if (area.isWarn) {
                        info += ` - 警報`;
                    }
                    info += `<br>`;
                }
                info += `</p>`;
            } else {
                info += `<p>地域ごとの予想震度(気象庁発表): 未発表</p>`;
            }
            }
        }
    }

    earthquakeInfo.innerHTML = info;
    if (warnings.some(warning => warning.iswarn)) {
        earthquakeInfo.classList.add('warn');
    } else {
        earthquakeInfo.classList.remove('warn');
    }
}


function getUserLocationFromCookie() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('userLocation='))
        ?.split('=')[1];
    return cookieValue ? decodeURIComponent(cookieValue) : null;
}

const locationElement = document.getElementById('location');
const userLocation = getUserLocationFromCookie();
if (userLocation) {
    locationElement.textContent = `現在地は ${userLocation}です`;
} else {
    locationElement.textContent = '現在地は登録されていません。.';
}

document.getElementById('save-button').addEventListener('click', () => {
    const userLocation = document.getElementById('user-location').value;
    const date = new Date();
    date.setFullYear(date.getFullYear() + 1);
    document.cookie = `userLocation=${encodeURIComponent(userLocation)}; expires=${date.toUTCString()}; path=/`;
});

async function getEarthquakeInformation() {
  try {
    const response = await fetch('https://dev.narikakun.net/webapi/earthquake/post_data.json', {
      cache: 'no-store'
    });
    const data = await response.json();
    const earthquakeList = document.getElementById('earthquake-list');
    if (data.Head.Title === '震度速報') {
      let intensityObservations = '';
      if (data.Body.Intensity && data.Body.Intensity.Observation && data.Body.Intensity.Observation.Pref) {
        for (const pref of data.Body.Intensity.Observation.Pref) {
          if (pref.Area) {
            for (const area of pref.Area) {
              intensityObservations += `<p>${area.Name}: 震度${area.MaxInt}</p>`;
            }
          }
        }
      }
      earthquakeList.innerHTML = `
        <p>震度速報</p>
        ${intensityObservations}
        <p>情報: ${data.Body.Comments.Observation}</p>
      `;
    } else if (data.Control.Title === '震源に関する情報') {
      let depth = data.Body.Earthquake.Hypocenter.Depth;
      if (depth === '0') {
        depth = 'ごく浅い';
      } else {
        depth += ' km';
      }
      earthquakeList.innerHTML = `
        <p>震源地: ${data.Body.Earthquake.Hypocenter.Name}</p>
        <p>${data.Body.Earthquake.OriginTime.replace(/-/g, '/')} 頃発生</p>
        <p>マグニチュード: ${data.Body.Earthquake.Magnitude}</p>
        <p>深さ: ${depth}</p>
        <p>情報: ${data.Body.Comments.Observation}</p>
      `;
    } else if (data.Head.Title === '遠地地震に関する情報') {
      earthquakeList.innerHTML = `
        <p>遠地地震に関する情報</p>
        <p>震源地: ${data.Body.Earthquake.Hypocenter.Name}</p>
        <p>${data.Body.Earthquake.OriginTime.replace(/-/g, '/')} 頃発生</p>
        <p>マグニチュード: ${data.Body.Earthquake.Magnitude}</p>
        <p>情報: ${data.Body.Comments.Observation}</p>
      `;
    } else if (data.Body) {
      let maxIntensity = '';
      if (data.Body.Intensity && data.Body.Intensity.Observation && data.Body.Intensity.Observation.MaxInt) {
        maxIntensity = `<p>最大震度: ${data.Body.Intensity.Observation.MaxInt}</p>`;
      }
      let depth = data.Body.Earthquake.Hypocenter.Depth;
      if (depth === '0') {
        depth = 'ごく浅い';
      } else {
        depth += ' km';
      }
      earthquakeList.innerHTML = `
        <p>震源地: ${data.Body.Earthquake.Hypocenter.Name}</p>
        <p>${data.Body.Earthquake.OriginTime.replace(/-/g, '/')} 頃発生</p>
        <p>マグニチュード: ${data.Body.Earthquake.Magnitude}</p>
        ${maxIntensity}
        <p>深さ: ${depth}</p>
        <p>情報: ${data.Body.Comments.Observation}</p>
      `;
    } else {
      earthquakeList.innerHTML = `<p>地震情報はありません。</p>`;
    }
  } catch (error) {
    console.error(error);
    const earthquakeList = document.getElementById('earthquake-list');
    earthquakeList.innerHTML = `<p>データの取得に失敗しました。</p>`;
  }
}
main();
getEarthquakeInformation();

function callMain() {
    main();
    setTimeout(callMain, 2500);
}

setTimeout(callMain, 2500);
function callEarthquakeInformation() {
    getEarthquakeInformation();
    setTimeout(callEarthquakeInformation, 5000);
}

setTimeout(callEarthquakeInformation, 5000);
      </script>
   </body>
</html>
